<!--
 * @Author: Dongzy
 * @since: 2020-01-10 11:13:53
 * @lastTime     : 2020-01-10 14:30:06
 * @LastAuthor   : Dongzy
 * @文件相对于项目的路径: \DailyInterviewQuestion\Answer\Vue\双向数据绑定实现.md
 * @message:
 -->

# 双向数据绑定实现

![](https://cn.vuejs.org/images/data.png)

## 简介

> 文档
> 当你把一个普通的 JavaScript 对象传入 Vue 实例作为 data 选项，Vue 将遍历此对象所有的属性，并使用 Object.defineProperty 把这些属性全部转为 getter/setter。Object.defineProperty 是 ES5 中一个无法 shim 的特性，这也就是 Vue 不支持 IE8 以及更低版本浏览器的原因。

## MVVM 双向数据绑定

主要指数据变化更新视图，试图变化更新数据
即数据的入口和出口，都会影响到另一方面，其中浏览器中的 View 变化可以通过事件监听的方式实现，所以主要讨论如何根据 Data 变化区更新 View

设计上通过四个步骤来设计，

1. 实现一个监听器 Obverse，用来劫持和监听所有属性，属性发生变化，通知订阅者
2. 实现一个订阅器 Dep，用来收集订阅者，对监听器 Obverse 和订阅者 Watcher 进行数据分发
3. 实现一个订阅者 Watcher，收到属性变化通知并执行相应方法，更新视图
4. 实现一个解析器 Compile，可以解析每个节点的相关指令对模板数据和订阅器（更新函数）初始化

## Observer 实现

Vue2.0 源码中使用 Object.defineProperty()来劫持各个数据属性的 setter/getter，Object.defineProperty 方法在 MDN 上定义为，在对象上定义一个新属性，或修一个对象的现有属性，并返回一个对象。

[MDN 链接](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)

### 具体实现

1. 字面量定义对象

```js
let person = {
  name: 'tom',
  age: 18,
};
```

可以直接用.操作符取出其中的属性值

2. Object.defineProperty()定义对象

```js
let val = 'tom';
let person = {};
Object.definProperty(person, 'name', {
  get() {
    console.log('读取name');
    return val;
  },
  set(newVal) {
    console.log('修改name');
    val = newVal;
  },
});
```

通过这个方法给 person 的 name 定义了 get()和 set()进行拦截

3. 改进方案

一个个属性去设置有点太不程序化，所以直接遍历对象中属性让属性其中所有属性都可观测。

```js
/**
 * 循环遍历数据对象的每个属性
 */
function observable(obj) {
  if (!obj || typeof obj !== 'object') {
    return;
  }
  let keys = Object.keys(obj);
  keys.forEach(key => {
    defineReactive(obj, key, obj[key]);
  });
  return obj;
}
/**
 * 将对象的属性用 Object.defineProperty() 进行设置
 */
function defineReactive(obj, key, val) {
  Object.defineProperty(obj, key, {
    get() {
      console.log(`${key}属性被读取了...`);
      return val;
    },
    set(newVal) {
      console.log(`${key}属性被修改了...`);
      val = newVal;
    },
  });
}
```

调用这个所有对象属性都是“可观测的”

## 订阅器 Dep 实现

### 发布-订阅设计模式

​ 发布-订阅模式和观察者模式（其实不一样，`在发布-订阅模式，消息的发送方，叫做发布者（publishers），消息不会直接发送给特定的接收者，叫做订阅者。`），它定义对象间的一种一对多的依赖关系，当一个对象的状态改变时，所有依赖于它的对象都将得到通知。
在这个模式中，消息会发布给一个中介，由中介过滤和分配输入的信息
![](https://user-gold-cdn.xitu.io/2017/11/22/15fe1b1f174cd376?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)
在这里我们实现的就是那个中介。Dep。
